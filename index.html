<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Kiểm tra FFmpeg.wasm</title>
    <style>
        body { font-family: sans-serif; background-color: #282c34; color: white; padding: 20px; }
        #status { font-size: 1.5em; font-weight: bold; }
        #log { white-space: pre-wrap; background-color: #20232a; border: 1px solid #61dafb; padding: 10px; margin-top: 20px; font-family: monospace; max-height: 400px; overflow-y: auto; }
        button { font-size: 1.2em; padding: 10px 20px; cursor: pointer; }
    </style>
    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
</head>
<body>

    <h1>Trình Kiểm Tra Tải FFmpeg.wasm</h1>
    <p>Nhấn nút bên dưới để bắt đầu quá trình tải và khởi tạo FFmpeg.</p>
    <button id="test-btn">Bắt đầu Kiểm tra</button>
    <h2 id="status">Trạng thái: Sẵn sàng</h2>
    <h3>Log chi tiết:</h3>
    <pre id="log">Chưa có log.</pre>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const statusEl = document.getElementById('status');
            const logEl = document.getElementById('log');
            const testBtn = document.getElementById('test-btn');
            const { createFFmpeg } = FFmpeg;

            const runTest = async () => {
                testBtn.disabled = true;
                logEl.textContent = ''; // Xóa log cũ

                try {
                    // Bước 1: Khởi tạo
                    statusEl.textContent = 'Trạng thái: Đang tạo instance FFmpeg...';
                    statusEl.style.color = 'orange';
                    const ffmpeg = createFFmpeg({ log: true }); // Bật log để xem chi tiết trong Console

                    // Ghi lại log của FFmpeg vào phần tử <pre>
                    ffmpeg.setLogger(({ type, message }) => {
                        logEl.textContent += `[${type}] ${message}\n`;
                        logEl.scrollTop = logEl.scrollHeight; // Tự cuộn xuống
                    });

                    // Bước 2: Tải thư viện lõi (đây là bước hay bị lỗi)
                    statusEl.textContent = 'Trạng thái: Đang tải lõi FFmpeg (có thể mất vài giây)...';
                    await ffmpeg.load();
                    statusEl.textContent = 'Trạng thái: Tải thành công!';
                    statusEl.style.color = 'lightgreen';

                    // Bước 3: Chạy một lệnh đơn giản để xác nhận
                    statusEl.textContent = 'Trạng thái: Đang chạy lệnh `ffmpeg -version`...';
                    await ffmpeg.run('-version');
                    
                    statusEl.textContent = 'Trạng thái: Hoàn tất! FFmpeg hoạt động tốt.';
                    
                } catch (error) {
                    console.error("Đã xảy ra lỗi trong quá trình kiểm tra:", error);
                    statusEl.textContent = 'Trạng thái: Thất bại! Không thể tải hoặc chạy FFmpeg.';
                    statusEl.style.color = 'tomato';
                    logEl.textContent += `\nLỖI CHI TIẾT:\n${error.toString()}`;
                } finally {
                    testBtn.disabled = false;
                }
            };

            testBtn.addEventListener('click', runTest);
        });
    </script>

</body>
</html>
